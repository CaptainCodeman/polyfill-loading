<!doctype html>
<html lang="en">

<head>
  <title>polyfilling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="Description" content="Example to test polyfill loading">

  <base href="/">

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
    }
  </style>

  <link rel="preload" href="https://polyfill.io/v3/polyfill.min.js?callback=polyfilled&features=IntersectionObserver,ResizeObserver" as="script">

  <link rel="preload" href="/scripts/index.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="/scripts/store.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="/scripts/views.js" as="script" crossorigin="anonymous">
  <link rel="preload" href="/scripts/vendor.js" as="script" crossorigin="anonymous">

  <script>
    const polyfillsRequired = !(
      'IntersectionObserver' in window && 
      'IntersectionObserverEntry' in window && 
      'intersectionRatio' in window.IntersectionObserverEntry.prototype &&
      'ResizeObserver' in window
    )

    console.log('polyfills required', polyfillsRequired)

    window.Polyfilled = polyfillsRequired
      ? new Promise(resolve => window.polyfilled = resolve)
      : Promise.resolve()

    // Promise-less:
    // window.Polyfilled = {
    //   resolved: false,
    //   cbs: [],
    //   then(cb) {
    //     if (this.resolved) {
    //       cb()
    //     } else {
    //       this.cbs.push(cb)
    //     }
    //   },
    //   resolve() {
    //     for (var i = 0; i < this.cbs.length; i++) {
    //       this.cbs[i]()
    //     }
    //     this.resolved = true
    //   }
    // }
    // window.polyfilled = window.Polyfilled.resolve.bind(window.Polyfilled)

    // minified
    // window.Polyfilled={r:!1,cbs:[],then(l){this.r?l():this.cbs.push(l)},resolve(){for(var l=0;l<this.cbs.length;l++)this.cbs[l]();this.r=!0}},window.polyfilled=window.Polyfilled.resolve.bind(window.Polyfilled);

    window.Polyfilled.then(() => console.log('polyfilled'))
  </script>
  <script async src="https://polyfill.io/v3/polyfill.min.js?callback=polyfilled&features=IntersectionObserver,ResizeObserver"></script>
  <script async src="/scripts/index.js" type="module"></script>
</head>

<body>
  <app-shell></app-shell>
</body>

</html>